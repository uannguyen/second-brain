![[oop-159.png]]

# Concept

***Memento is a behavioral design pattern that lets you save and restore the previous state of an object without revealing the details of its implementation.***

- Memento là pattern cho phép lưu lại & khôi phục trạng thái trước đó của một object mà không tiết lộ chi tiết về việc thực hiện nó

*Hãy tưởng tượng bạn đang chơi một trò chơi xếp hình Lego. Bạn xây dựng một tòa lâu đài Lego thật đẹp. Nhưng đôi khi bạn muốn thử thay đổi một số phần của lâu đài để nó trông khác đi. Nhưng bạn lại sợ rằng nếu thay đổi, bạn sẽ không thể trở lại trạng thái ban đầu của tòa lâu đài. Vậy phải làm sao?*

# Problem

- Hãy tưởng tượng ta tạo một text editor app
	- Ngoài việc chỉnh sửa simple text, editor có thể format text, insert inline images, etc
	
- Tại một số thời điểm, ta quyết định cho phép users undo any operations đã thực hiện trên text
	- Để implementation, ta chọn cách tiếp cận trực tiếp
	- Trước khi thực hiện any operation, app ghi lại state của all objects và saves vào bộ nhớ
	- Sau đó, khi user muốn revert, app fetches bản ghi mới nhất từ history & sử dụng nó để restore state của all objects

![[oop-160.png]]

- Hãy nghĩ về những state snapshots đó
	- Để restore thì cần phải go over all fields trong object & copy values vào bộ nhớ
	- Tuy nhiên điều này gặp khó khăn vì private fields
	
- Tại sao không khai báo fields ở dạng public ?
	- Giả sử để fields ở dạng public, việc copy thoải mái
	- => Tuy nhiên, trong tương lai khi cấu trúc của classes thay đổi như add & remove fields thì ta phải thay đổi code chịu trách nhiệm copying state cho các objects class bị ảnh hưởng
	- Làm cho maintain phức tạp và dễ gây lỗi

![[oop-161.png]]

- Snapshots của editor's state cần phải lưu trữ các thông tin như actual text, cursor coordinates, curren scroll position, etc
	- Để tạo được thì cần thu thập values và đặt trong một nơi là container
	
- Khả năng cao là các container objects này được storaged trong một list đại diện cho history
	- Thành ra, các container có thể là object class có ít method nhưng nhiều fields để phản ánh editor state
	- Để cho phép other objects write & read data từ snapshot thì phải để fields là public
	- Điều này sẽ làm expose editor's state, kể cả private hay không private
	- Other classes sẽ trở nên phụ thuộc vào mỗi little change của snapshot class
	
- Cuối cùng chúng ta gặp phải một vấn đề khá nhức trứng:
	- Một là public all fields - kém an toàn
	- Hai là private một fields cần thiết, tuy nhiên vậy thì không implement "undo" được
	
# Solution

- All problems gặp ở trên là do broken encapsilation
	- Some objects cố gắng làm nhiều hơn những gì nó phải làm
	- Để thu thập data, chúng xâm chiếm private space của other objects thay vì để các object này thực hiện action thực tế
	
- Memento pattern ủy thác việc creating state snapshots cho class chứa state đó, là `originator` object
	- Do đó, thay vì để other object copy editor's state từ bên ngoài, chính editor class có thể tạo snapshot
	
- The pattern gợi ý storing bản sao của các object's state vào special object called `memento`
	- Contents của memento không thể truy cập được từ bất kỳ object nào khác ngoại trừ object đã tạo ra nó
	- Other objects phải communicate with memento bằng interface cho phép fetching snapshot's metadata(creation time, operation name, ...), nhưng không phải original object's state ban đầu chứa trong snapshot

![[oop-162.png]]

- Restrictive polity(chính sách hạn chế) cho phép lưu trữ mementos bên trong other objects, thường được called `caretakers`
	- Khi caretaker works with memento chỉ thông qua limited interface, nó không thể giả mạo state stored bên trong memento
	- Đồng thời, originator có quyền access to all fields bên trong memento, làm nó restore previous state tùy ý
	
- Trong text editor example, có thể tạo một history class riêng đóng vai trò caretaker
	- Một stack of mementos stored inside caretaker sẽ grow mỗi khi editor execute một operation
	- Thậm chí có thể render this stack này ở app's UI, hiển thị history của các hoạt động trước đó cho user
	
- Khi user triggers undo, history lấy memento gần đây nhất từ stack và passes nó lại cho editor, yêu cầu roll-back
	- Vì editor có full access to memento, nó thay đổi own state với values lấy được từ memento
	
	
	
	
	
	